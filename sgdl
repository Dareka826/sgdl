#!/bin/sh

# Print usage based on docopt
usage() {
	echo "Simple Gelbooru Downloader"
	echo ""
	echo "Usage:"
	echo "  sgdl [-f] -i <id>..."
	echo "  sgdl [-f] -p <pid>"
	echo "  sgdl [-f] -t <tags>"
	echo "  sgdl [-f] -t <tags> -p <pid>"
	echo ""
	echo "Options:"
	echo "  -h            Show this text"
	echo "  -i <id>...    Specify the id/ids of posts to download"
	echo "  -p <pid>      Specify a page id"
	echo "  -t <tags>     Specify tags to search with"
	echo "  -f            Enable fringe content"

	exit 0
}

# Gets image url from an id
get_image() {
	# $1 - ID
	[ "$1" = "" ] && return
	echo $(curl -sL "https://gelbooru.com/index.php" \
		--cookie "fringeBenefits=$FRINGE" \
		-G -d "page=post" -d "s=view" \
		-d "id=$1" | \
			grep -Po "href=\"http.*?Original image" | \
			grep -Po "\"http.*?\"" | \
			grep -o "[^\"]*")
}

# Downloads one or multiple id(s)
# $1 - IDs
download_ids() {
	for id in $1; do
		local URL=$(get_image $id)
		printf "\n[$id]: $URL\n"
		curl -LO $URL
	done
}

# Gets the next page id from the current one
# $1 - Current PID
next_pid() {
	local PID=$1
	[ "$PID" = "" ] && local PID=0
	echo $(( $PID + 42 )) # Hardcoded???
}

# Gets ids of posts on a specified page
# $1 - PID
get_page_ids() {
	local PID=$1
	[ "$PID" = "" ] && local PID=0
	echo $(curl -sL "https://gelbooru.com/index.php"\
		-G -d "page=post" -d "s=list" \
		--cookie "fringeBenefits=$FRINGE" \
		-d "pid=$PID" | \
			grep -Po "\"//gelbooru.*?id=[0-9]+.*?\"" | \
			grep -Po "id=[0-9]+" | grep -o "[0-9]*")
}

# Get ids of posts with specified tags on a specified page
# $1 - PID
# $2 - TAGS
get_tag_page_ids() {
	local PID=$1
	[ "$PID" = "" ] && local PID=0
	local TAGS=$2
	[ "$TAGS" = "" ] && return
	echo $(curl -sL "https://gelbooru.com/index.php" \
		-G -d "page=post" -d "s=list" \
		--cookie "fringeBenefits=$FRINGE" \
		--data-urlencode "tags=$TAGS" \
		-d "pid=$PID" | \
			grep -Po "\"//gelbooru.*?id=[0-9]+.*?\"" \
			| grep -Po "id=[0-9]+" | grep -o "[0-9]*")
}

FRINGE="nope"
IDS=""
PID=""
TAGS=""
while [ "$1" != "" ]; do
	case $1 in
		"-f") FRINGE="yup" ;;
		"-i") IDS="$2"; shift ;;
		"-p") PID="$2"; shift ;;
		"-t") TAGS="$2"; shift ;;
		"-h") usage ;;
	esac
	shift
done

if [ "$IDS" != "" ]; then
	# ID mode
	download_ids "$IDS"
else
	if [ "$PID" != "" ]; then 
		if [ "$TAGS" = "" ]; then
			# Page mode
			download_ids $(get_page_ids $PID)
		else
			# Tags + pid
			download_ids $(get_tag_page_ids $PID "$TAGS")
		fi
	else
		if [ "$TAGS" != "" ]; then
			# Tag mode
			PID=0
			IDS=$(get_tag_page_ids $PID "$TAGS")
			while [ "$IDS" != "" ]; do
				printf "\n= PID: $PID\n\n"
				download_ids "$IDS"
				PID=$(next_pid $PID)
				IDS=$(get_tag_page_ids $PID "$TAGS")
			done
		fi
	fi
fi

